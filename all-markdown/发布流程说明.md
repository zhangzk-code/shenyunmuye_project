# CMS发布流程说明

## 📋 概述

现在CMS系统已经实现了完整的发布流程，确保：
- **保存操作**：只保存草稿，不影响网站显示
- **预览功能**：预览草稿内容（修改后的效果）
- **发布操作**：只有点击发布后，内容才会在网站上显示给最终用户

## 🔄 工作流程

### 1. 编辑内容
- 在管理后台编辑页面内容
- 修改任何字段后，会显示"有未保存的修改"提示

### 2. 保存草稿
- 点击"保存"按钮
- 内容保存到 `site-content.json`（草稿）
- **重要**：此时网站不会显示修改的内容
- 提示："内容已保存为草稿（未发布，网站不会显示）"

### 3. 预览内容
- 点击"预览"按钮
- 预览窗口会显示**草稿内容**（修改后的效果）
- 预览URL包含 `preview=true` 参数
- 预览页面顶部会显示黄色提示条："⚠️ 预览模式：当前显示的是未发布的草稿内容"

### 4. 发布内容
- 点击"发布"按钮
- 系统会：
  1. 将草稿内容复制到 `site-content.published.json`（已发布内容）
  2. 同时更新网站后端的已发布内容文件
  3. 网站前端现在会显示最新发布的内容
- 提示："页面已成功发布！网站现在显示最新内容"

## 📁 文件结构

### 草稿内容（编辑中）
- **位置**：`shenyunmuye-backend/data/site-content.json`
- **用途**：存储管理员编辑的内容（未发布）
- **访问**：只有管理后台可以读写

### 已发布内容（网站显示）
- **位置**：`shenyunmuye-backend/data/site-content.published.json`
- **用途**：存储已发布的内容（网站前端读取）
- **访问**：网站前端只读取此文件

## 🔧 技术实现

### 后端API

#### 1. 保存内容（草稿）
```
PUT /api/admin/content/page/:page/section/:section
```
- 保存到 `site-content.json`（草稿）
- 不影响已发布内容

#### 2. 预览内容
```
GET /api/content?page=home&preview=true
```
- 读取草稿内容（`site-content.json`）
- 用于预览功能

#### 3. 网站读取内容
```
GET /api/content?page=home
```
- 读取已发布内容（`site-content.published.json`）
- 如果已发布内容不存在，回退到草稿内容（向后兼容）

#### 4. 发布内容
```
POST /api/admin/publish/page/:page
Body: { "publish": true }
```
- 将草稿内容复制到已发布内容
- 同时更新网站后端的已发布内容文件

#### 5. 检查发布状态
```
GET /api/admin/publish/page/:page
```
- 返回是否有未发布的修改
- 用于显示发布按钮状态

### 前端实现

#### 预览功能
- 预览URL包含 `preview=true` 参数
- 网站前端检测到此参数后，会：
  1. 在API请求中添加 `preview=true` 参数
  2. 显示预览模式提示条

#### 发布状态指示
- 发布按钮会根据发布状态改变颜色：
  - **橙色**：有未发布的修改
  - **绿色**：已发布，网站显示最新内容

## ⚠️ 重要说明

### 向后兼容
- 如果已发布内容文件不存在，系统会使用草稿内容
- 首次使用时，系统会自动从当前内容创建已发布内容文件

### 数据安全
- 草稿和已发布内容是分离的
- 可以安全地编辑和预览，不会影响网站显示
- 只有明确点击"发布"后，内容才会更新到网站

### 预览模式
- 预览时，网站前端会显示黄色提示条
- 提示用户当前看到的是未发布的草稿内容
- 预览不会影响已发布内容

## 🎯 使用示例

### 场景1：编辑首页内容

1. **编辑内容**
   - 进入"内容管理" → 选择"首页"
   - 修改"品牌信息"中的品牌名称
   - 显示"有未保存的修改"

2. **保存草稿**
   - 点击"保存"按钮
   - 提示："内容已保存为草稿（未发布，网站不会显示）"
   - 网站仍然显示旧内容

3. **预览效果**
   - 点击"预览"按钮
   - 预览窗口显示修改后的内容
   - 预览页面顶部显示黄色提示条

4. **发布内容**
   - 确认无误后，点击"发布"按钮
   - 确认发布对话框
   - 提示："首页已成功发布！网站现在显示最新内容"
   - 网站现在显示新内容

### 场景2：多次编辑后发布

1. 编辑内容 → 保存草稿
2. 继续编辑 → 保存草稿
3. 预览效果
4. 确认无误后 → 发布
5. 只有最后一次保存的内容会被发布

## 🔍 故障排查

### 问题：预览显示的内容和网站不一致

**原因**：预览显示草稿内容，网站显示已发布内容

**解决**：
- 这是正常行为
- 预览显示的是修改后的草稿
- 网站显示的是已发布的内容
- 发布后两者会一致

### 问题：保存后网站立即显示了修改

**原因**：可能是向后兼容逻辑导致

**解决**：
- 检查 `site-content.published.json` 文件是否存在
- 如果不存在，系统会使用草稿内容（向后兼容）
- 发布一次后，系统会创建已发布内容文件

### 问题：发布按钮颜色不对

**原因**：发布状态检查失败

**解决**：
- 检查网络连接
- 查看浏览器控制台错误
- 手动刷新页面

---

**版本**：v1.0  
**更新日期**：2024年

