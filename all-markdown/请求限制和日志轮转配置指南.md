# 请求限制和日志轮转配置指南

## 概述

本文档介绍如何为申允木业项目配置请求限制和日志轮转，以提高服务稳定性和可维护性。

## 一、日志轮转配置

### 1.1 使用 logrotate（推荐）

logrotate 是 Linux 系统自带的日志轮转工具，可以自动管理日志文件。

#### 安装 logrotate

大多数 Linux 发行版已预装 logrotate，如果没有：

```bash
# CentOS/RHEL
sudo yum install logrotate

# Ubuntu/Debian
sudo apt-get install logrotate
```

#### 配置步骤

**方法1：使用自动配置脚本**

```bash
# 1. 修改脚本中的路径
chmod +x logrotate配置.sh
sudo ./logrotate配置.sh
```

**方法2：手动配置**

```bash
# 1. 复制配置文件模板
sudo cp logrotate配置示例.conf /etc/logrotate.d/shenyunmuye

# 2. 编辑配置文件，修改路径
sudo nano /etc/logrotate.d/shenyunmuye

# 将 /path/to/shenyunmuye_project 替换为实际路径
# 例如: /root/shenyunmuye_project
```

#### 配置说明

```conf
/path/to/shenyunmuye_project/logs/*.log {
    daily                    # 每天轮转
    rotate 7                 # 保留7天的日志
    compress                 # 压缩旧日志
    delaycompress            # 延迟压缩（不压缩当天的日志）
    missingok                # 如果日志文件不存在，不报错
    notifempty               # 如果日志文件为空，不轮转
    create 0644 root root    # 创建新日志文件的权限和所有者
}
```

**参数说明**：
- `daily`: 每天轮转一次
- `rotate 7`: 保留7个旧日志文件（7天）
- `compress`: 使用 gzip 压缩旧日志
- `delaycompress`: 延迟压缩，当天日志不压缩
- `missingok`: 日志文件不存在时不报错
- `notifempty`: 空日志文件不轮转
- `create`: 创建新日志文件的权限和所有者

#### 测试配置

```bash
# 测试配置（不实际执行）
sudo logrotate -d /etc/logrotate.d/shenyunmuye

# 手动执行轮转（用于测试）
sudo logrotate -f /etc/logrotate.d/shenyunmuye

# 查看logrotate状态
cat /var/lib/logrotate/status | grep shenyunmuye
```

#### 高级配置

**按大小轮转**（日志文件超过指定大小时轮转）：
```conf
/path/to/logs/*.log {
    size 100M              # 超过100MB时轮转
    rotate 5               # 保留5个旧日志
    compress
    missingok
    notifempty
    create 0644 root root
}
```

**按大小和日期轮转**（结合使用）：
```conf
/path/to/logs/*.log {
    daily
    size 100M              # 每天或超过100MB时轮转
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
```

**轮转后执行脚本**（如重启服务）：
```conf
/path/to/logs/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
    create 0644 root root
    postrotate
        # 发送信号给进程重新打开日志文件
        kill -USR1 $(cat /path/to/pids/service.pid) 2>/dev/null || true
    endscript
}
```

### 1.2 手动清理日志脚本

如果不想使用 logrotate，可以创建定时任务手动清理：

```bash
#!/bin/bash
# 清理旧日志脚本

LOG_DIR="/path/to/shenyunmuye_project/logs"
DAYS_TO_KEEP=7

# 删除7天前的日志文件
find "$LOG_DIR" -name "*.log" -type f -mtime +$DAYS_TO_KEEP -delete

# 压缩3天前的日志
find "$LOG_DIR" -name "*.log" -type f -mtime +3 ! -name "*.gz" -exec gzip {} \;

echo "日志清理完成: $(date)"
```

添加到 crontab：
```bash
# 每天凌晨2点执行
0 2 * * * /path/to/清理日志.sh >> /var/log/log-cleanup.log 2>&1
```

## 二、请求限制配置

### 2.1 使用 Nginx 反向代理（推荐）

Nginx 提供了强大的请求限制功能，适合生产环境。

#### 安装 Nginx

```bash
# CentOS/RHEL
sudo yum install nginx

# Ubuntu/Debian
sudo apt-get install nginx
```

#### 配置步骤

1. **复制配置文件**：
```bash
sudo cp nginx请求限制配置.conf /etc/nginx/conf.d/shenyunmuye-limits.conf
```

2. **修改配置**：
```bash
sudo nano /etc/nginx/conf.d/shenyunmuye-limits.conf
```

修改以下内容：
- 将 `/path/to/shenyunmuye_project` 替换为实际路径
- 调整限制参数（连接数、请求速率等）
- 修改域名（如果有）

3. **测试配置**：
```bash
sudo nginx -t
```

4. **重载配置**：
```bash
sudo nginx -s reload
# 或
sudo systemctl reload nginx
```

#### 限制参数说明

```nginx
# 限制每个IP的连接数
limit_conn conn_limit_per_ip 10;  # 每个IP最多10个并发连接

# 限制每个IP的请求速率
limit_req zone=req_limit_per_ip burst=20 nodelay;  
# rate=10r/s: 每秒最多10个请求
# burst=20: 允许突发20个请求
# nodelay: 立即处理突发请求

# 限制总连接数
limit_conn conn_limit_per_server 1000;  # 整个服务器最多1000个连接
```

#### 自定义错误页面

创建 429 错误页面：
```bash
sudo nano /usr/share/nginx/html/429.html
```

内容：
```html
<!DOCTYPE html>
<html>
<head>
    <title>429 Too Many Requests</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>请求过于频繁</h1>
    <p>您的请求过于频繁，请稍后再试。</p>
</body>
</html>
```

在 Nginx 配置中添加：
```nginx
error_page 429 /429.html;
location = /429.html {
    root /usr/share/nginx/html;
    internal;
}
```

### 2.2 使用 iptables（简单场景）

iptables 可以在网络层限制连接，适合简单的限制需求。

#### 配置步骤

```bash
# 1. 使用配置脚本
chmod +x iptables请求限制.sh
sudo ./iptables请求限制.sh

# 2. 保存规则
# CentOS/RHEL
sudo service iptables save

# Ubuntu/Debian
sudo apt-get install iptables-persistent
sudo netfilter-persistent save
```

#### 手动配置示例

```bash
# 限制每个IP的并发连接数（端口8081）
sudo iptables -A INPUT -p tcp --dport 8081 -m connlimit --connlimit-above 10 --connlimit-mask 32 -j REJECT

# 限制新连接速率（每秒最多5个新连接）
sudo iptables -A INPUT -p tcp --dport 8081 -m state --state NEW -m limit --limit 5/second --limit-burst 10 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8081 -m state --state NEW -j DROP

# 封禁特定IP
sudo iptables -A INPUT -p tcp --dport 8081 -s 204.76.203.51 -j DROP
```

#### 查看规则

```bash
# 查看所有规则
sudo iptables -L -n -v

# 查看特定端口的规则
sudo iptables -L -n -v | grep 8081
```

### 2.3 使用 fail2ban（防止暴力破解）

fail2ban 可以监控日志文件，自动封禁恶意IP。

#### 安装 fail2ban

```bash
# CentOS/RHEL
sudo yum install fail2ban

# Ubuntu/Debian
sudo apt-get install fail2ban
```

#### 配置示例

创建配置文件 `/etc/fail2ban/jail.local`：

```ini
[DEFAULT]
bantime = 3600        # 封禁时间（秒）
findtime = 600        # 查找时间窗口（秒）
maxretry = 5          # 最大失败次数

[sshd]
enabled = true

[nginx-limit-req]
enabled = true
port = http,https
filter = nginx-limit-req
logpath = /var/log/nginx/error.log
maxretry = 10
```

## 三、推荐配置方案

### 方案1：生产环境（完整方案）

1. **使用 Nginx 反向代理**
   - 配置请求限制
   - 配置 SSL/HTTPS
   - 配置访问日志

2. **使用 logrotate 管理日志**
   - 每天轮转
   - 保留7天
   - 自动压缩

3. **使用 fail2ban 防护**
   - 监控登录失败
   - 自动封禁恶意IP

### 方案2：简单环境（基础方案）

1. **使用 iptables 限制连接**
   - 限制并发连接数
   - 限制新连接速率

2. **使用 logrotate 管理日志**
   - 基本配置即可

## 四、监控和维护

### 查看日志轮转状态

```bash
# 查看logrotate状态
cat /var/lib/logrotate/status | grep shenyunmuye

# 查看日志文件
ls -lh /path/to/logs/

# 查看压缩的日志
ls -lh /path/to/logs/*.gz
```

### 查看请求限制效果

```bash
# Nginx访问日志
sudo tail -f /var/log/nginx/access.log | grep 429

# iptables统计
sudo iptables -L -n -v | grep REJECT

# 查看被限制的连接
sudo netstat -an | grep 8081 | wc -l
```

### 定期检查

创建检查脚本：

```bash
#!/bin/bash
# 检查日志和限制状态

echo "=== 日志文件大小 ==="
du -sh /path/to/logs/*.log

echo "=== 日志轮转状态 ==="
cat /var/lib/logrotate/status | grep shenyunmuye

echo "=== 当前连接数 ==="
netstat -an | grep -E '3000|3001|8080|8081' | wc -l

echo "=== 被拒绝的连接 ==="
sudo iptables -L -n -v | grep REJECT
```

## 五、故障排查

### 问题1：日志轮转不工作

**检查**：
```bash
# 检查logrotate配置
sudo logrotate -d /etc/logrotate.d/shenyunmuye

# 检查logrotate日志
sudo cat /var/log/cron | grep logrotate

# 手动执行测试
sudo logrotate -f /etc/logrotate.d/shenyunmuye
```

### 问题2：请求限制过严

**调整Nginx配置**：
```nginx
# 增加限制
limit_conn conn_limit_per_ip 20;  # 从10增加到20
limit_req zone=req_limit_per_ip burst=30 nodelay;  # 从20增加到30
```

**调整iptables规则**：
```bash
# 删除旧规则
sudo iptables -D INPUT -p tcp --dport 8081 -m connlimit --connlimit-above 10 -j REJECT

# 添加新规则
sudo iptables -A INPUT -p tcp --dport 8081 -m connlimit --connlimit-above 20 -j REJECT
```

### 问题3：日志文件权限问题

```bash
# 修复日志文件权限
sudo chown root:root /path/to/logs/*.log
sudo chmod 644 /path/to/logs/*.log
```

## 六、最佳实践

1. **日志轮转**
   - ✅ 每天轮转，保留7-30天
   - ✅ 自动压缩旧日志
   - ✅ 监控日志文件大小

2. **请求限制**
   - ✅ 限制每个IP的连接数（10-20个）
   - ✅ 限制请求速率（10-20 req/s）
   - ✅ 对登录接口使用更严格的限制

3. **安全防护**
   - ✅ 封禁已知的恶意IP
   - ✅ 使用fail2ban自动封禁
   - ✅ 定期检查访问日志

4. **监控告警**
   - ✅ 监控日志文件大小
   - ✅ 监控被拒绝的连接数
   - ✅ 设置告警阈值

## 七、相关文件

- `logrotate配置.sh` - 自动配置logrotate的脚本
- `logrotate配置示例.conf` - logrotate配置模板
- `nginx请求限制配置.conf` - Nginx限制配置模板
- `iptables请求限制.sh` - iptables限制配置脚本

## 八、参考资源

- [logrotate 官方文档](https://linux.die.net/man/8/logrotate)
- [Nginx 限制模块文档](http://nginx.org/en/docs/http/ngx_http_limit_req_module.html)
- [iptables 文档](https://linux.die.net/man/8/iptables)

