# 预览功能验证

## ✅ 预览功能流程

预览功能已经正确配置为读取草稿内容。以下是完整的流程：

### 1. 预览URL构建
**文件**：`shenyunmuye-admin-frontend/cms/preview/preview.js` 第235行
```javascript
const previewUrl = `${websiteBaseUrl}/${pageFileName}?preview=true&device=${this.currentDevice.id}&t=${Date.now()}`;
```
- ✅ 预览URL包含 `preview=true` 参数

### 2. 网站前端检测预览模式
**文件**：`shenyunmuye-website/js/content.js` 第12-16行
```javascript
const urlParams = new URLSearchParams(window.location.search);
const isPreview = urlParams.get('preview') === 'true';
const previewParam = isPreview ? '&preview=true' : '';
const response = await fetch(`${API_BASE_URL}/content?page=${pageKey}${previewParam}`);
```
- ✅ 检测到 `preview=true` 参数
- ✅ 在API请求中添加 `preview=true` 参数

### 3. 网站后端处理预览请求
**文件**：`shenyunmuye-backend/server.js` 第184-187行
```javascript
const preview = req.query.preview === 'true'; // 预览模式，读取草稿内容
const content = await getMergedContent(preview);
```
- ✅ 检测 `preview=true` 参数
- ✅ 调用 `getMergedContent(true)` 读取草稿内容

### 4. 读取草稿内容
**文件**：`shenyunmuye-backend/server.js` 第140-142行
```javascript
if (useDraft) {
    // 预览模式：读取草稿内容
    stored = await loadJsonFile(CONTENT_FILE, {}); // 读取草稿文件
}
```
- ✅ 预览模式时读取 `CONTENT_FILE`（草稿文件）
- ✅ 正常模式时读取 `PUBLISHED_CONTENT_FILE`（已发布文件）

## 🔍 调试日志

已添加调试日志，可以在控制台查看：

### 网站后端日志
- `[API] 预览模式请求 - 页面: xxx - 将读取草稿内容`
- `[预览模式] 读取草稿内容文件: xxx`
- `[预览模式] 草稿内容已加载，页面数: x`

### 网站前端日志
- `[网站前端] 预览模式已检测，将请求草稿内容`
- `[网站前端] 请求API: xxx`

### 管理后台预览日志
- `加载预览URL: xxx`
- `预览模式：将显示草稿内容（未发布）`

## ✅ 验证步骤

1. **打开管理后台预览**
   - 在管理后台点击"预览"按钮
   - 查看浏览器控制台，应该看到：
     - `加载预览URL: http://...?preview=true&...`
     - `预览模式：将显示草稿内容（未发布）`

2. **查看网站前端控制台**
   - 打开预览窗口后，在预览窗口的开发者工具中查看控制台
   - 应该看到：
     - `[网站前端] 预览模式已检测，将请求草稿内容`
     - `[网站前端] 请求API: http://.../api/content?page=home&preview=true`

3. **查看网站后端控制台**
   - 应该看到：
     - `[API] 预览模式请求 - 页面: home - 将读取草稿内容`
     - `[预览模式] 读取草稿内容文件: .../site-content.json`
     - `[预览模式] 草稿内容已加载，页面数: x`

4. **验证预览内容**
   - 在管理后台修改内容并保存（不发布）
   - 打开预览，应该看到修改后的内容（草稿内容）
   - 直接访问网站（无preview参数），应该看到旧内容（已发布内容）

## 🎯 关键点

- ✅ **预览模式**：URL包含 `preview=true` → 读取草稿内容
- ✅ **正常模式**：URL无 `preview=true` → 读取已发布内容
- ✅ **保存操作**：只保存到草稿文件，不影响已发布内容
- ✅ **发布操作**：将草稿内容复制到已发布文件

## ⚠️ 如果预览没有显示草稿内容

1. **检查URL参数**
   - 确认预览URL包含 `preview=true`
   - 可以在浏览器地址栏查看

2. **检查控制台日志**
   - 查看网站后端日志，确认是否进入预览模式
   - 查看网站前端日志，确认是否检测到预览模式

3. **检查文件内容**
   - 确认草稿文件（`site-content.json`）有最新内容
   - 确认已发布文件（`site-content.published.json`）是旧内容

4. **清除缓存**
   - 浏览器硬刷新（Ctrl+F5）
   - 重启网站后端服务

---

**最后更新**：2024年

