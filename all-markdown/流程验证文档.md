# CMSå‘å¸ƒæµç¨‹éªŒè¯æ–‡æ¡£

## ğŸ“‹ æµç¨‹éªŒè¯

æŒ‰ç…§è¦æ±‚çš„æµç¨‹ä¸¥æ ¼æ£€æŸ¥ä»£ç å®ç°ï¼š

```
ç¼–è¾‘å†…å®¹ â†’ ä¿å­˜è‰ç¨¿ â†’ é¢„è§ˆæ•ˆæœ â†’ å‘å¸ƒå†…å®¹ â†’ ç½‘ç«™æ˜¾ç¤º
   â†“           â†“          â†“          â†“          â†“
 ä¿®æ”¹å­—æ®µ   ä¿å­˜åˆ°     é¢„è§ˆè‰ç¨¿   å¤åˆ¶åˆ°å·²   ç½‘ç«™è¯»å–
           è‰ç¨¿æ–‡ä»¶    å†…å®¹æ˜¾ç¤º   å‘å¸ƒæ–‡ä»¶   å·²å‘å¸ƒå†…å®¹
```

## âœ… æ­¥éª¤1ï¼šç¼–è¾‘å†…å®¹ â†’ ä¿®æ”¹å­—æ®µ

**ä½ç½®**ï¼šç®¡ç†åå°å‰ç«¯ (`admin.html`)
- ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­ä¿®æ”¹å­—æ®µ âœ“
- å­—æ®µä¿®æ”¹åæ ‡è®°ä¸º"æœ‰æœªä¿å­˜çš„ä¿®æ”¹" âœ“

## âœ… æ­¥éª¤2ï¼šä¿å­˜è‰ç¨¿ â†’ ä¿å­˜åˆ°è‰ç¨¿æ–‡ä»¶

**API**ï¼š`PUT /api/admin/content/page/:page/section/:section`
**æ–‡ä»¶**ï¼š`shenyunmuye-admin-backend/server.js` ç¬¬592-614è¡Œ

```javascript
// è¯»å–è‰ç¨¿æ–‡ä»¶
const current = await getContentRaw(); // è¯»å– CONTENT_FILEï¼ˆè‰ç¨¿ï¼‰

// æ›´æ–°è‰ç¨¿å†…å®¹
current.pages[page][section] = payload;

// ä¿å­˜åˆ°è‰ç¨¿æ–‡ä»¶
await fs.writeFile(CONTENT_FILE, JSON.stringify(current, null, 2));
```

**éªŒè¯**ï¼šâœ“ åªå†™å…¥ `CONTENT_FILE`ï¼ˆè‰ç¨¿æ–‡ä»¶ï¼‰ï¼Œä¸å½±å“å·²å‘å¸ƒå†…å®¹

## âœ… æ­¥éª¤3ï¼šé¢„è§ˆæ•ˆæœ â†’ é¢„è§ˆè‰ç¨¿å†…å®¹æ˜¾ç¤º

**é¢„è§ˆURLæ„å»º**ï¼š`shenyunmuye-admin-frontend/cms/preview/preview.js` ç¬¬235è¡Œ
```javascript
const previewUrl = `${websiteBaseUrl}/${pageFileName}?preview=true&device=${this.currentDevice.id}`;
```

**ç½‘ç«™å‰ç«¯æ£€æµ‹**ï¼š`shenyunmuye-website/js/content.js` ç¬¬11è¡Œ
```javascript
const isPreview = urlParams.get('preview') === 'true';
const previewParam = isPreview ? '&preview=true' : '';
const response = await fetch(`${API_BASE_URL}/content?page=${pageKey}${previewParam}`);
```

**ç½‘ç«™åç«¯å¤„ç†**ï¼š`shenyunmuye-backend/server.js` ç¬¬139-145è¡Œ
```javascript
const preview = req.query.preview === 'true';
const content = await getMergedContent(preview); // preview=true æ—¶è¯»å–è‰ç¨¿
```

**getMergedContentå‡½æ•°**ï¼šç¬¬106-129è¡Œ
```javascript
if (useDraft) {
    // é¢„è§ˆæ¨¡å¼ï¼šè¯»å–è‰ç¨¿å†…å®¹
    stored = await loadJsonFile(CONTENT_FILE, {});
} else {
    // æ­£å¸¸æ¨¡å¼ï¼šåªè¯»å–å·²å‘å¸ƒå†…å®¹
    stored = await loadJsonFile(PUBLISHED_CONTENT_FILE, {});
}
```

**éªŒè¯**ï¼šâœ“ é¢„è§ˆæ—¶è¯»å–è‰ç¨¿å†…å®¹ï¼ˆ`CONTENT_FILE`ï¼‰

## âœ… æ­¥éª¤4ï¼šå‘å¸ƒå†…å®¹ â†’ å¤åˆ¶åˆ°å·²å‘å¸ƒæ–‡ä»¶

**API**ï¼š`POST /api/admin/publish/page/:page`
**æ–‡ä»¶**ï¼š`shenyunmuye-admin-backend/server.js` ç¬¬836-890è¡Œ

```javascript
// è¯»å–è‰ç¨¿å†…å®¹
const draftContent = await getContentRaw(); // è¯»å– CONTENT_FILEï¼ˆè‰ç¨¿ï¼‰

// è¯»å–å·²å‘å¸ƒå†…å®¹
const publishedContent = await loadJsonFile(PUBLISHED_CONTENT_FILE, {});

// å°†è‰ç¨¿å†…å®¹å¤åˆ¶åˆ°å·²å‘å¸ƒå†…å®¹
if (page === 'global') {
    publishedContent.global = draftContent.global || {};
} else {
    publishedContent.pages[page] = draftContent.pages?.[page] || {};
}

// ä¿å­˜å·²å‘å¸ƒå†…å®¹
await fs.writeFile(PUBLISHED_CONTENT_FILE, JSON.stringify(publishedContent, null, 2));

// åŒæ—¶æ›´æ–°ç½‘ç«™åç«¯çš„å·²å‘å¸ƒå†…å®¹æ–‡ä»¶
const websitePublishedFile = path.join(__dirname, '..', 'shenyunmuye-backend', 'data', 'site-content.published.json');
await fs.writeFile(websitePublishedFile, JSON.stringify(publishedContent, null, 2));
```

**éªŒè¯**ï¼šâœ“ ä»è‰ç¨¿æ–‡ä»¶è¯»å–ï¼Œå¤åˆ¶åˆ°å·²å‘å¸ƒæ–‡ä»¶

## âœ… æ­¥éª¤5ï¼šç½‘ç«™æ˜¾ç¤º â†’ ç½‘ç«™è¯»å–å·²å‘å¸ƒå†…å®¹

**API**ï¼š`GET /api/content?page=home`ï¼ˆæ— previewå‚æ•°ï¼‰
**æ–‡ä»¶**ï¼š`shenyunmuye-backend/server.js` ç¬¬139-145è¡Œ

```javascript
const preview = req.query.preview === 'true';
const content = await getMergedContent(preview); // preview=false æ—¶è¯»å–å·²å‘å¸ƒå†…å®¹
```

**getMergedContentå‡½æ•°**ï¼šç¬¬106-129è¡Œ
```javascript
if (useDraft) {
    // é¢„è§ˆæ¨¡å¼ï¼šè¯»å–è‰ç¨¿å†…å®¹
    stored = await loadJsonFile(CONTENT_FILE, {});
} else {
    // æ­£å¸¸æ¨¡å¼ï¼šåªè¯»å–å·²å‘å¸ƒå†…å®¹ï¼ˆç½‘ç«™æ˜¾ç¤ºï¼‰
    try {
        stored = await loadJsonFile(PUBLISHED_CONTENT_FILE, {});
        if (!stored.global && !stored.pages) {
            stored = {}; // ä½¿ç”¨é»˜è®¤å†…å®¹ï¼Œä¸å›é€€åˆ°è‰ç¨¿
        }
    } catch {
        stored = {}; // ä½¿ç”¨é»˜è®¤å†…å®¹ï¼Œä¸å›é€€åˆ°è‰ç¨¿
    }
}
```

**éªŒè¯**ï¼šâœ“ ç½‘ç«™åªè¯»å–å·²å‘å¸ƒå†…å®¹ï¼ˆ`PUBLISHED_CONTENT_FILE`ï¼‰ï¼Œä¸å›é€€åˆ°è‰ç¨¿

## ğŸ” ç®¡ç†åå°è¯»å–å†…å®¹

**API**ï¼š`GET /api/admin/content`
**æ–‡ä»¶**ï¼š`shenyunmuye-admin-backend/server.js` ç¬¬515-523è¡Œ

```javascript
const content = await getContentDataMerged(); // è¯»å–è‰ç¨¿å†…å®¹ï¼ˆç”¨äºç¼–è¾‘ï¼‰
```

**getContentDataMergedå‡½æ•°**ï¼šç¬¬259-264è¡Œ
```javascript
async function getContentDataMerged() {
    const defaults = await loadJsonFile(CONTENT_DEFAULT_FILE, {});
    const stored = await loadJsonFile(CONTENT_FILE, {}); // è¯»å–è‰ç¨¿æ–‡ä»¶
    return deepMerge(defaults, stored);
}
```

**éªŒè¯**ï¼šâœ“ ç®¡ç†åå°è¯»å–è‰ç¨¿å†…å®¹ï¼ˆå› ä¸ºè¦ç¼–è¾‘ï¼‰

## ğŸ“Š æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†åå°ç¼–è¾‘                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚ ç¼–è¾‘å­—æ®µ     â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚ ä¿å­˜                                          â”‚
â”‚         â–¼                                               â”‚
â”‚  PUT /api/admin/content/page/:page/section/:section     â”‚
â”‚         â”‚                                               â”‚
â”‚         â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ CONTENT_FILE    â”‚ â† è‰ç¨¿æ–‡ä»¶ï¼ˆç¼–è¾‘ä¸­ï¼‰              â”‚
â”‚  â”‚ (è‰ç¨¿)          â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ é¢„è§ˆï¼ˆpreview=trueï¼‰
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢„è§ˆçª—å£                                               â”‚
â”‚  GET /api/content?preview=true                         â”‚
â”‚         â”‚                                               â”‚
â”‚         â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ CONTENT_FILE    â”‚ â† è¯»å–è‰ç¨¿å†…å®¹                     â”‚
â”‚  â”‚ (è‰ç¨¿)          â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ å‘å¸ƒ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘å¸ƒæ“ä½œ                                               â”‚
â”‚  POST /api/admin/publish/page/:page                    â”‚
â”‚         â”‚                                               â”‚
â”‚         â”œâ”€ è¯»å– CONTENT_FILE (è‰ç¨¿)                    â”‚
â”‚         â”‚                                               â”‚
â”‚         â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ PUBLISHED_CONTENT_FILE   â”‚ â† å·²å‘å¸ƒæ–‡ä»¶ï¼ˆç½‘ç«™æ˜¾ç¤ºï¼‰ â”‚
â”‚  â”‚ (å·²å‘å¸ƒ)                 â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ç½‘ç«™è®¿é—®ï¼ˆæ— previewå‚æ•°ï¼‰
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘ç«™å‰ç«¯                                               â”‚
â”‚  GET /api/content                                       â”‚
â”‚         â”‚                                               â”‚
â”‚         â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ PUBLISHED_CONTENT_FILE   â”‚ â† åªè¯»å–å·²å‘å¸ƒå†…å®¹       â”‚
â”‚  â”‚ (å·²å‘å¸ƒ)                 â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… éªŒè¯ç»“æœ

æ‰€æœ‰æ­¥éª¤éƒ½ä¸¥æ ¼æŒ‰ç…§æµç¨‹å®ç°ï¼š

1. âœ… **ç¼–è¾‘å†…å®¹** â†’ ä¿®æ”¹å­—æ®µ
2. âœ… **ä¿å­˜è‰ç¨¿** â†’ åªä¿å­˜åˆ° `CONTENT_FILE`ï¼ˆè‰ç¨¿æ–‡ä»¶ï¼‰
3. âœ… **é¢„è§ˆæ•ˆæœ** â†’ è¯»å– `CONTENT_FILE`ï¼ˆè‰ç¨¿å†…å®¹ï¼‰
4. âœ… **å‘å¸ƒå†…å®¹** â†’ ä» `CONTENT_FILE` å¤åˆ¶åˆ° `PUBLISHED_CONTENT_FILE`
5. âœ… **ç½‘ç«™æ˜¾ç¤º** â†’ åªè¯»å– `PUBLISHED_CONTENT_FILE`ï¼ˆå·²å‘å¸ƒå†…å®¹ï¼‰

## ğŸ”§ å…³é”®ä¿®å¤

1. âœ… ä¿®å¤äº†ç½‘ç«™åç«¯è¯»å–é€»è¾‘ï¼Œä¸å†å›é€€åˆ°è‰ç¨¿
2. âœ… ä¿®å¤äº†é¢„è§ˆåˆ·æ–°æ—¶ä¿ç•™ `preview=true` å‚æ•°
3. âœ… ç¡®ä¿å‘å¸ƒæ“ä½œå®Œæ•´å¤åˆ¶è‰ç¨¿å†…å®¹åˆ°å·²å‘å¸ƒæ–‡ä»¶

---

**éªŒè¯æ—¥æœŸ**ï¼š2024å¹´

