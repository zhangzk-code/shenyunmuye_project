# 服务用户配置说明

## 当前配置

### 所有服务都以 root 用户运行

- **Nginx 前端服务**: `root` 用户
- **前端网站后端**: `root` 用户  
- **管理后台后端**: `root` 用户

## 为什么都使用 root？

### 1. 需要访问 /root 目录

- 前端文件在 `/root/shenyunmuye-website`
- 后端数据在 `/root/shenyunmuye-backend/data`
- 上传文件在 `/root/shenyunmuye-backend/uploads`
- `/root` 目录默认权限是 700，只有 root 可以访问

### 2. 数据共享

- 管理后台后端需要访问前端网站后端的数据目录
- 所有数据都在 `/root` 目录下

### 3. 简单统一

- 所有服务使用同一用户，避免权限问题
- 简化配置和维护

## 目录结构

```
/root/
├── shenyunmuye-website/          (root:root, 755) - Nginx 访问
├── shenyunmuye-admin-frontend/   (root:root, 755) - Nginx 访问
├── shenyunmuye-backend/          (root:root, 755) - 后端服务
│   ├── data/                     (root:root, 755) - 数据文件
│   └── uploads/                   (root:root, 755) - 上传文件
├── shenyunmuye-admin-backend/    (root:root, 755) - 后端服务
│   └── data/                      (root:root, 755) - 数据文件
├── logs/                          (root:root, 755) - 所有服务日志
└── pids/                          (root:root, 755) - 所有服务PID文件
```

## 启动服务

```bash
./启动所有服务.sh
```

启动脚本会自动：
- 以 root 用户运行所有服务
- 设置必要的目录权限（755）
- 确保日志和 PID 目录可写

## 验证配置

### 检查进程用户

```bash
# 检查所有服务进程
ps aux | grep -E "nginx|node.*server.js" | grep -v grep
```

**预期输出**：
```
root     12321  ... nginx: master process
root     12322  ... nginx: worker process
root     12345  ... node shenyunmuye-backend/server.js
root     12346  ... node shenyunmuye-admin-backend/server.js
```

所有进程都应该以 `root` 用户运行。

### 检查目录权限

```bash
# 检查项目目录权限
ls -ld /root/shenyunmuye-*

# 检查日志和PID目录权限
ls -ld /root/logs /root/pids
```

## 安全说明

### 使用 root 用户的风险

- ⚠️ **安全风险**: root 用户权限过大
- ⚠️ **攻击影响**: 如果服务被攻击，影响范围更大

### 为什么在这个场景下可以接受？

1. **专用服务器**: 通常只有管理员访问
2. **内网环境**: 如果在内网部署，风险较低
3. **简单性**: 避免复杂的权限配置
4. **功能优先**: 确保服务正常运行

### 如果希望提高安全性

可以考虑：

1. **将项目移动到 /opt 或 /var/www**
   ```bash
   sudo mv /root/shenyunmuye-* /opt/
   # 然后修改 Nginx 配置和启动脚本中的路径
   ```

2. **使用 systemd 服务**
   - 创建 systemd 服务文件
   - 可以配置更细粒度的权限

3. **使用容器化**
   - Docker 可以提供更好的隔离

## 故障排查

### 问题1: 服务无法访问数据文件

**检查**:
```bash
# 检查数据目录权限
ls -la shenyunmuye-backend/data/
ls -la shenyunmuye-admin-backend/data/

# 检查进程用户
ps aux | grep "node.*server.js" | grep -v grep
```

**修复**:
```bash
# 确保以 root 运行
sudo ./启动所有服务.sh
```

### 问题2: 无法写入日志

**修复**:
```bash
sudo chmod -R 755 logs pids
```

### 问题3: Nginx 无法访问文件

**检查**:
```bash
# 检查 Nginx 用户
sudo grep "^user" /etc/nginx/nginx.conf

# 检查文件权限
ls -la /root/shenyunmuye-website/index.html
```

**修复**:
```bash
# 修改 Nginx 用户为 root
sudo sed -i 's/^user .*/user root;/' /etc/nginx/nginx.conf
sudo systemctl restart nginx
```

## 总结

✅ **当前配置**:
- 所有服务：root 用户
- 原因：需要访问 /root 目录
- 优势：简单、统一、功能正常

✅ **启动脚本已配置**:
- 自动以 root 用户运行所有服务
- 自动设置目录权限

现在可以直接使用 `./启动所有服务.sh` 启动所有服务！
