# 服务诊断与故障排查指南

## 概述

本文档介绍如何诊断和排查服务问题，包括进程状态、网络连接、日志分析等。

## 快速诊断

### 使用诊断脚本

```bash
# 诊断管理后台（交互式）
./诊断管理后台.sh

# 诊断指定端口
./诊断管理后台.sh --port 8081

# 诊断指定PID
./诊断管理后台.sh --pid 12345

# 诊断 Nginx
sudo ./诊断nginx.sh
```

诊断脚本会自动检查：
- 进程状态和资源使用
- 网络连接状态
- 日志文件
- PID 文件
- 文件描述符
- 内存和 CPU 使用
- 错误统计

## 常见问题诊断

### 问题1: 服务无响应但端口在监听

**症状**:
- 端口显示 LISTEN 状态
- 进程存在
- 但无法响应 HTTP 请求

**可能原因**:
1. 进程卡死/死锁
2. 连接队列满
3. 大量 CLOSE_WAIT 连接
4. 资源耗尽

**诊断步骤**:
```bash
# 1. 检查进程状态
ps -p <PID> -o pid,cmd,%mem,%cpu,stat,etime

# 2. 检查网络连接
netstat -anp | grep <PORT>
ss -tulnp | grep <PORT>

# 3. 检查 CLOSE_WAIT 连接
netstat -an | grep <PORT> | grep CLOSE_WAIT

# 4. 检查资源使用
lsof -p <PID> | wc -l  # 文件描述符数量
ps -p <PID> -o rss,vsz  # 内存使用
```

**解决方案**:
- 重启服务（最简单）
- 替换为生产级服务器（Nginx）
- 配置请求限制

### 问题2: 404 Not Found

**症状**:
- 访问返回 404
- 但文件确实存在

**可能原因**:
1. 配置文件路径不正确
2. Nginx 用户无权限访问文件
3. SELinux 阻止访问

**诊断步骤**:
```bash
# 1. 检查配置文件
sudo grep "root" /etc/nginx/conf.d/shenyunmuye.conf

# 2. 检查文件是否存在
ls -la /root/shenyunmuye-website/index.html

# 3. 检查 Nginx 用户
sudo grep "^user" /etc/nginx/nginx.conf

# 4. 查看错误日志
sudo tail -50 /var/log/nginx/error.log
```

**解决方案**:
```bash
# 使用诊断脚本
sudo ./诊断nginx.sh

# 修复路径
sudo ./配置nginx.sh

# 修复权限
sudo sed -i 's/^user .*/user root;/' /etc/nginx/nginx.conf
sudo systemctl restart nginx
```

### 问题3: 连接超时

**症状**:
- `curl` 连接超时
- `telnet` 连接被拒绝

**可能原因**:
1. 防火墙阻止
2. 服务未启动
3. 端口被其他进程占用
4. 连接队列满

**诊断步骤**:
```bash
# 1. 检查服务状态
sudo systemctl status nginx

# 2. 检查端口监听
sudo netstat -tulnp | grep <PORT>

# 3. 检查防火墙
sudo firewall-cmd --list-ports  # CentOS 7+
sudo iptables -L -n  # 其他系统

# 4. 测试本地连接
curl -v http://localhost:<PORT>/
```

### 问题4: SYN_RECV 连接一直不变，无法访问

**症状**:
- 大量 SYN_RECV 状态的连接
- 连接数不减少
- 网站无法访问

**可能原因**:
1. **SYN Flood 攻击** - 恶意 IP 发送大量 SYN 包
2. **连接队列满** - 系统无法处理新连接
3. **防火墙规则** - 阻止了连接完成
4. **网络问题** - 网络延迟或丢包

**诊断步骤**:
```bash
# 1. 检查 SYN_RECV 连接
netstat -an | grep SYN_RECV | wc -l
netstat -an | grep SYN_RECV | head -20

# 2. 查看恶意 IP
netstat -an | grep SYN_RECV | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn

# 3. 检查系统参数
sysctl net.ipv4.tcp_max_syn_backlog
sysctl net.ipv4.tcp_syncookies

# 4. 使用诊断脚本
sudo ./修复SYN_RECV连接问题.sh
```

**解决方案**:

**方法1: 使用修复脚本（推荐）**
```bash
sudo ./修复SYN_RECV连接问题.sh
```

脚本会自动：
- 优化系统 TCP 参数
- 配置防火墙规则限制连接速率
- 清理现有的 SYN_RECV 连接
- 配置 Nginx 请求限制

**方法2: 手动优化系统参数**
```bash
# 编辑 /etc/sysctl.conf
sudo nano /etc/sysctl.conf

# 添加以下内容
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_abort_on_overflow = 1
net.ipv4.tcp_syncookies = 1

# 应用配置
sudo sysctl -p
```

**方法3: 封禁恶意 IP**
```bash
# 查看恶意 IP
sudo ./修复SYN_RECV连接问题.sh

# 封禁 IP
sudo ./封禁恶意IP.sh

# 解除封禁（如果需要）
sudo ./解除IP封禁.sh <IP地址>
```

**方法4: 配置防火墙限制连接速率**
```bash
# 使用 iptables 限制每个 IP 的连接速率
sudo iptables -I INPUT -p tcp --dport 8080 -m state --state NEW -m recent --set --name http
sudo iptables -I INPUT -p tcp --dport 8080 -m state --state NEW -m recent --update --seconds 60 --hitcount 20 --name http -j DROP

# 限制 SYN 包速率
sudo iptables -A INPUT -p tcp --syn -m limit --limit 10/s --limit-burst 20 -j ACCEPT
sudo iptables -A INPUT -p tcp --syn -j DROP
```

### 问题4: 日志文件过大

**症状**:
- 日志文件占用大量磁盘空间
- 服务响应变慢

**解决方案**:
```bash
# 配置日志轮转
sudo ./logrotate配置.sh

# 或手动配置
sudo nano /etc/logrotate.d/shenyunmuye
```

## 详细诊断项

### 1. 进程状态

```bash
# 查看进程详细信息
ps -p <PID> -o pid,ppid,user,cmd,%mem,%cpu,stat,etime,start

# 查看进程树
pstree -p <PID>

# 查看线程
ps -T -p <PID>
```

### 2. 资源使用

```bash
# 文件描述符数量
lsof -p <PID> | wc -l

# 内存使用
ps -p <PID> -o rss,vsz

# CPU 使用
top -p <PID>

# 系统资源
free -h
df -h
```

### 3. 网络连接

```bash
# 查看所有连接
netstat -anp | grep <PORT>

# 按状态统计
netstat -an | grep <PORT> | awk '{print $6}' | sort | uniq -c

# 查看连接详情
ss -tulnp | grep <PORT>

# 查看进程的网络连接
lsof -p <PID> | grep TCP
```

### 4. 日志分析

```bash
# 查看最后 N 行
tail -n 50 <log_file>

# 实时查看
tail -f <log_file>

# 搜索错误
grep -i "error\|exception\|traceback\|failed" <log_file>

# 统计错误数量
grep -i "error" <log_file> | wc -l

# 查看最近1小时的访问
grep "$(date -d '1 hour ago' '+%d/%b/%Y:%H')" <log_file>
```

### 5. 文件权限

```bash
# 检查文件权限
ls -la <file_path>

# 检查目录权限
ls -ld <dir_path>

# 检查进程用户
ps -p <PID> -o user

# 测试文件读取
sudo -u <user> cat <file_path>
```

## 诊断脚本使用

### 诊断管理后台

```bash
./诊断管理后台.sh
```

脚本会：
1. 显示服务选择菜单
2. 自动查找 PID 和端口
3. 检查进程状态
4. 检查资源使用
5. 检查网络连接
6. 分析日志文件
7. 检查 PID 文件
8. 提供智能建议

### 诊断 Nginx

```bash
sudo ./诊断nginx.sh
```

脚本会：
1. 检查配置文件语法
2. 检查文件路径和权限
3. 检查 Nginx 进程状态
4. 检查端口监听
5. 查看错误日志
6. 查看访问日志
7. 测试配置

## 紧急恢复

如果服务完全无响应：

```bash
# 1. 强制停止
kill -9 <PID>

# 2. 检查端口是否释放
netstat -tuln | grep <PORT>

# 3. 清理可能的僵尸进程
ps aux | grep <service> | grep -v grep

# 4. 重新启动服务
./启动所有服务.sh

# 5. 验证服务
sleep 2
curl http://localhost:<PORT>/
```

## 预防措施

1. **使用生产级服务器**: 不要在生产环境使用 `python -m http.server`
2. **添加监控**: 监控进程状态、资源使用、响应时间
3. **日志管理**: 定期清理或轮转日志文件
4. **资源限制**: 设置合理的文件描述符和连接数限制
5. **防火墙规则**: 限制访问来源，减少恶意请求
6. **定期检查**: 使用诊断脚本定期检查服务状态

## 相关文件

- `诊断管理后台.sh` - 通用服务诊断脚本
- `诊断nginx.sh` - Nginx 专用诊断脚本
- `修复SYN_RECV连接问题.sh` - 修复 SYN_RECV 连接问题
- `封禁恶意IP.sh` - 封禁恶意 IP 地址
- `解除IP封禁.sh` - 解除 IP 封禁
- `启动所有服务.sh` - 启动所有服务
- `停止所有服务.sh` - 停止所有服务

---

## 总结

✅ **快速诊断**: 使用 `./诊断管理后台.sh`  
✅ **详细分析**: 查看日志和资源使用  
✅ **紧急恢复**: 重启服务并验证  
✅ **预防措施**: 使用生产级服务器和监控  

